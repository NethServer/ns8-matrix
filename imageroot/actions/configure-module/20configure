#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import agent
import agent.tasks
import os

request = json.load(sys.stdin)

# Get configuration parameters
synapse_domain_name = request.get('synapse_domain_name', '')
element_domain_name = request.get('element_domain_name', '')
cinny_domain_name = request.get('cinny_domain_name', '')
lets_encrypt = request.get('lets_encrypt', False)
ldap_domain = request.get('ldap_domain', '')
mail_from = request.get('mail_from', '')
nethvoice_auth_url = request.get('nethvoice_auth_url', '')

if not synapse_domain_name:
    print("ERROR: Synapse_domain_name is required", file=sys.stderr)
    sys.exit(1)

# Read current configuration
if os.path.exists("config.env"):
    env_vars = agent.read_envfile("config.env")
else:
    env_vars = {}

# Update environment with new configuration
env_vars['SYNAPSE_DOMAIN_NAME'] = synapse_domain_name
env_vars['ELEMENT_DOMAIN_NAME'] = element_domain_name
env_vars['CINNY_DOMAIN_NAME'] = cinny_domain_name
env_vars['LDAP_DOMAIN'] = ldap_domain
env_vars['MAIL_FROM'] = mail_from
env_vars['LETS_ENCRYPT'] = '1' if lets_encrypt else '0'
env_vars['NETHVOICE_AUTH_URL'] = nethvoice_auth_url

# Get allocated TCP ports from environment - NS8 allocates sequential ports
tcp_ports = os.environ.get('TCP_PORTS', '20001').split(',')

# Assign ports to services
env_vars['SYNAPSE_PORT'] = tcp_ports[0]
env_vars['ELEMENT_WEB_PORT'] = tcp_ports[1]
env_vars['CINNY_PORT'] = tcp_ports[2]
env_vars['POSTGRES_PORT'] = tcp_ports[3]
env_vars['M2A_PROXY_PORT'] = tcp_ports[4]

# Write updated configuration
agent.write_envfile("config.env", env_vars)

# For later use and backup
with open('config.json', 'w') as cfp:
    cfp.write(json.dumps(request))

# Configure Traefik routes for Synapse Matrix server
response = agent.tasks.run(
    agent_id=agent.resolve_agent_id('traefik@node'),
    action='set-route',
    data={
        'instance': os.environ['MODULE_ID'] + '-synapse',
        'url': 'http://127.0.0.1:' + env_vars['SYNAPSE_PORT'],
        'host': synapse_domain_name,
        'http2https': True,
        'lets_encrypt': lets_encrypt,
    },
)
agent.assert_exp(response['exit_code'] == 0)

# Configure Traefik routes for Element Web client
if element_domain_name:
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='set-route',
        data={
            'instance': os.environ['MODULE_ID'] + '-element',
            'url': 'http://127.0.0.1:' + env_vars['ELEMENT_WEB_PORT'],
            'host': element_domain_name,
            'http2https': True,
            'lets_encrypt': lets_encrypt,
        },
    )
    agent.assert_exp(response['exit_code'] == 0)
else:
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='delete-route',
        data={
            'instance': os.environ['MODULE_ID'] + '-element'
        },
    )

# Configure Traefik routes for Cinny client
if cinny_domain_name:
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='set-route',
        data={
            'instance': os.environ['MODULE_ID'] + '-cinny',
            'url': 'http://127.0.0.1:' + env_vars['CINNY_PORT'],
            'host': cinny_domain_name,
            'http2https': True,
            'lets_encrypt': lets_encrypt,
        },
    )
    agent.assert_exp(response['exit_code'] == 0)
else:
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='delete-route',
        data={
            'instance': os.environ['MODULE_ID'] + '-cinny'
        },
    )

# Bind the new domain, overriding previous values (unbind)
agent.bind_user_domains([ldap_domain])


# Enable or disable matrix2acrobits proxy routes depending on nethvoice_auth_url
m2a_port = env_vars.get('M2A_PROXY_PORT', '')
module_id = os.environ.get('MODULE_ID', 'matrix1')

if nethvoice_auth_url:
    proxy_url = 'http://127.0.0.1:' + (m2a_port if m2a_port else '8080')
    # create /m2a route
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='set-route',
        data={
            'instance': module_id + '-m2a',
            'name': module_id + '-m2a',
            'host': synapse_domain_name,
            'path': '/m2a',
            'url': proxy_url,
            'lets_encrypt': lets_encrypt,
            'strip_prefix': True,
        },
    )
    agent.assert_exp(response['exit_code'] == 0)

    # create push notification route
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='set-route',
        data={
            'instance': module_id + '-push',
            'name': module_id + '-push',
            'host': synapse_domain_name,
            'path': '/_matrix/push/v1/notify',
            'url': proxy_url,
            'lets_encrypt': lets_encrypt,
            'strip_prefix': False,
        },
    )
    agent.assert_exp(response['exit_code'] == 0)

    m2a = {
        'MATRIX_HOMESERVER_URL': 'https://' + synapse_domain_name,
        'PROXY_PORT': env_vars['M2A_PROXY_PORT'],
        'AS_USER_ID': '@_acrobits_proxy:' + synapse_domain_name,
        'EXT_AUTH_URL': nethvoice_auth_url,
        'LOGLEVEL': 'info',
    }
    agent.write_envfile("m2a.env", m2a)
else:
    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='delete-route',
        data={
            'instance': module_id + '-m2a'
        },
    )

    response = agent.tasks.run(
        agent_id=agent.resolve_agent_id('traefik@node'),
        action='delete-route',
        data={
            'instance': module_id + '-push'
        },
    )
