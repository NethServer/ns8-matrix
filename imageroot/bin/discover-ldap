#!/usr/bin/env python3

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

#
# Find settings for LDAP service
#

import os
import agent
from agent.ldapproxy import Ldapproxy

if os.path.exists("config.env"):
    config = agent.read_envfile("config.env")
else:
    config = {}

udomname = config.get('DEX_LDAP_DOMAIN','')

try:
    odom = Ldapproxy().get_domain(udomname)
    'host' in odom # Throw exception if odom is None
except:
    # During restore the domain could be unavailable. Use a fallback
    # configuration, pointing to nowhere, just to set the variables.
    # Once the domain becomes available, the event will fix them.
    odom = {
        'host': '127.0.0.1',
        'port': 20000,
        'schema': 'rfc2307',
        'location': 'internal',
        'base_dn': 'dc=dex,dc=invalid',
        'bind_dn': 'cn=example,dc=dex,dc=invalid',
        'bind_password': 'invalid',
    }

tmpfile = "ldap.env." + str(os.getpid())

if odom['schema'] == "rfc2307":
    with open(tmpfile, "w") as denv:
        print('DEX_LDAP_ID=ldap', file=denv)
        print('DEX_LDAP_NAME=LDAP', file=denv)
        print('DEX_LDAP_PORT=' + str(odom['port']), file=denv)
        print('DEX_LDAP_BIND_DN=' + odom['bind_dn'], file=denv)
        print('DEX_LDAP_HOST=' + odom['host'], file=denv)
        print('DEX_LDAP_BIND_PASSWORD=' + odom['bind_password'], file=denv)
        print('DEX_LDAP_SCHEMA=' + odom['schema'], file=denv)
        print('DEX_LDAP_BASE_DN=' + odom['base_dn'], file=denv)
        print('DEX_LDAP_USER_FILTER=(objectClass=inetOrgPerson)', file=denv)
        print('DEX_LDAP_USERNAME=uid', file=denv)
        print('DEX_LDAP_ID_ATTR=uid', file=denv)
        print('DEX_LDAP_EMAIL_ATTR=mail', file=denv)
        print('DEX_LDAP_NAME_ATTR=cn', file=denv)
        print('DEX_LDAP_GROUP_FILTER=(objectClass=groupOfNames)', file=denv)
elif odom['schema'] == "ad":
    with open(tmpfile, "w") as denv:
        print('DEX_LDAP_ID=ad', file=denv)
        print('DEX_LDAP_NAME=ActiveDirectory', file=denv)
        print('DEX_LDAP_PORT=' + str(odom['port']), file=denv)
        print('DEX_LDAP_BIND_DN=' + odom['bind_dn'], file=denv)
        print('DEX_LDAP_HOST=' + odom['host'], file=denv)
        print('DEX_LDAP_BIND_PASSWORD=' + odom['bind_password'], file=denv)
        print('DEX_LDAP_SCHEMA=' + odom['schema'], file=denv)
        print('DEX_LDAP_BASE_DN=' + odom['base_dn'], file=denv)
        print('DEX_LDAP_USER_FILTER=(objectClass=person)', file=denv)
        print('DEX_LDAP_USERNAME=cn', file=denv)
        print('DEX_LDAP_ID_ATTR=cn', file=denv)
        print('DEX_LDAP_EMAIL_ATTR=mail', file=denv)
        print('DEX_LDAP_NAME_ATTR=cn', file=denv)
        print('DEX_LDAP_GROUP_FILTER=(objectClass=group)', file=denv)

os.replace(tmpfile, "ldap.env")
